'use strict';

jest.mock('fs');
jest.unmock('../lib/utils/promises');
jest.unmock('../lib/main');

describe('Container', () => {
    let fs;
    let rc;

    beforeEach(() => {
        fs = require('fs');
        rc = require('../');

    });

    it('should load a container', () => {
        let container_path = 'res/container';

        fs.writeFileSync(container_path);
        fs.writeFileSync(container_path + '/package.json', JSON.stringify({
            package_version: rc.tools.spec.version
        }));
        fs.writeFileSync(container_path + '/content/config.yml', '---');

        return rc.load(container_path)
            .then(function(container) {
                expect(container.path).toEqual(container_path);
            });
    });

    it('should convert a legacy resource', () => {
        let data = JSON.stringify({"chapters": [{"frames": [{"format": "usx", "id": "01-01", "img": "", "lastvs": "2", "text": "<para style=\"p\">\n\n  <verse number=\"1\" style=\"v\" />That which was from the beginning\u2014which we have heard, which we have seen with our eyes, which we have looked at, and our hands have touched\u2014it is about the Word of life.\n\n  <verse number=\"2\" style=\"v\" />Also, the life was made known, and we have seen it, and we bear witness to it. We are announcing to you the eternal life, which was with the Father, and which has been made known to us.\n"}, {"format": "usx", "id": "01-03", "img": "", "lastvs": "4", "text": "  <verse number=\"3\" style=\"v\" />That which we have seen and heard we declare also to you, so you also will have fellowship with us. Our fellowship is with the Father and with his Son, Jesus Christ. \n\n  <verse number=\"4\" style=\"v\" />Also, we are writing these things to you so that our joy will be complete.\n\n<note caller=\"+\" style=\"f\">\n\n  <char style=\"ft\">Some older versions read, </char>\n\n  <char style=\"fqa\">And we are writing these things to you so that your joy will be complete. </char>\n\n  <char style=\"fqb\"></char>\n\n</note></para>\n\n<para style=\"b\" />\n"}, {"format": "usx", "id": "01-05", "img": "", "lastvs": "7", "text": "<para style=\"p\">\n\n  <verse number=\"5\" style=\"v\" />This is the message that we have heard from him and are announcing to you: God is light, and in him there is no darkness at all.\n\n  <verse number=\"6\" style=\"v\" />If we say that we have fellowship with him and walk in darkness, we are lying and are not practicing the truth.\n\n  <verse number=\"7\" style=\"v\" />But if we walk in the light as he is in the light, we have fellowship with one another, and the blood of Jesus his Son cleanses us from every sin.\n"}, {"format": "usx", "id": "01-08", "img": "", "lastvs": "10", "text": "  <verse number=\"8\" style=\"v\" />If we say that we have no sin, we are deceiving ourselves, and the truth is not in us.\n\n  <verse number=\"9\" style=\"v\" />But if we confess our sins, he is faithful and just to forgive us our sins and cleanse us from all unrighteousness.\n\n  <verse number=\"10\" style=\"v\" />If we say that we have not sinned, we make him out to be a liar, and his word is not in us.</para>\n"}], "number": "01", "ref": "", "title": ""}, {"frames": [{"format": "usx", "id": "02-01", "img": "", "lastvs": "3", "text": "<para style=\"p\">\n\n  <verse number=\"1\" style=\"v\" />Children, I am writing these things to you so that you will not sin. But if anyone sins, we have an advocate with the Father, Jesus Christ, the one who is righteous.\n\n  <verse number=\"2\" style=\"v\" />He is the propitiation for our sins, and not for ours only, but also for the whole world.\n\n  <verse number=\"3\" style=\"v\" />By this we know that we know him: if we keep his commandments.\n"}, {"format": "usx", "id": "02-04", "img": "", "lastvs": "6", "text": "  <verse number=\"4\" style=\"v\" />The one who says, \"I know God,\" but does not keep his commandments, is a liar, and the truth is not in him.\n\n  <verse number=\"5\" style=\"v\" />But whoever keeps his word, truly, it is in that person that the love of God has been perfected. By this we know that we are in him.\n\n  <verse number=\"6\" style=\"v\" />The one who says he remains in God should himself also walk just as Jesus Christ walked.</para>\n"}, {"format": "usx", "id": "02-07", "img": "", "lastvs": "8", "text": "<para style=\"p\">\n\n  <verse number=\"7\" style=\"v\" />Beloved, I am not writing a new commandment to you, but an old commandment that you have had from the beginning. The old commandment is the word that you heard.\n\n  <verse number=\"8\" style=\"v\" />Yet I am writing a new commandment to you, which is true in Christ and in you, because the darkness is passing away, and the true light is already shining.\n"}, {"format": "usx", "id": "02-09", "img": "", "lastvs": "11", "text": "  <verse number=\"9\" style=\"v\" />The one who says that he is in the light and hates his brother is in the darkness until now.\n\n  <verse number=\"10\" style=\"v\" />The one who loves his brother remains in the light and there is no occasion for stumbling in him.\n\n  <verse number=\"11\" style=\"v\" />But The one who hates his brother is in the darkness and walks in the darkness; he does not know where he is going, because the darkness has blinded his eyes.</para>\n"}, {"format": "usx", "id": "02-12", "img": "", "lastvs": "14", "text": "<para style=\"p\">\n\n  <verse number=\"12\" style=\"v\" />I am writing to you, dear children, because your sins are forgiven because of his name.\n\n  <verse number=\"13\" style=\"v\" />I am writing to you, fathers, because you know the one who is from the beginning. I am writing to you, young men, because you have overcome the evil one. I have written to you, little children, because you know the Father.\n\n  <verse number=\"14\" style=\"v\" />I have written to you, fathers, because you know the one who is from the beginning. I have written to you, young men, because you are strong, and the word of God remains in you, and you have overcome the evil one.\n"}, {"format": "usx", "id": "02-15", "img": "", "lastvs": "17", "text": "  <verse number=\"15\" style=\"v\" />Do not love the world nor the things that are in the world. If anyone loves the world, the love of the Father is not in him.\n\n  <verse number=\"16\" style=\"v\" />For everything that is in the world\u2014the lust of the flesh, the lust of the eyes, and the arrogance of life\u2014is not from the Father but is from the world.\n\n  <verse number=\"17\" style=\"v\" />The world and its desire are passing away. But whoever does the will of God will remain forever.</para>\n\n<para style=\"b\" />\n"}, {"format": "usx", "id": "02-18", "img": "", "lastvs": "19", "text": "<para style=\"p\">\n\n  <verse number=\"18\" style=\"v\" />Little children, it is the last hour. Just as you heard that the antichrist is coming, now many antichrists have come. By this we know that it is the last hour.\n\n  <verse number=\"19\" style=\"v\" />They went out from us, but they were not from us. For if they had been from us they would have remained with us. But when they went out, that showed they were not from us.\n"}, {"format": "usx", "id": "02-20", "img": "", "lastvs": "21", "text": "  <verse number=\"20\" style=\"v\" />But you have an anointing from the Holy One, and you all know the truth.\n\n<note caller=\"+\" style=\"f\">\n\n  <char style=\"ft\">Some other modern versions read, </char>\n\n  <char style=\"fqa\">and you have all knowledge. </char>\n\n  <char style=\"fqb\">Some older versions read, </char>\n\n  <char style=\"fqa\">and you know all things. </char>\n\n  <char style=\"fqb\"></char>\n\n</note>\n\n  <verse number=\"21\" style=\"v\" />I did not write to you because you do not know the truth, but because you know it and because no lie is from the truth.\n"}, {"format": "usx", "id": "02-22", "img": "", "lastvs": "23", "text": "  <verse number=\"22\" style=\"v\" />Who is the liar but the one who denies that Jesus is the Christ? That person is the antichrist, since he denies the Father and the Son.\n\n  <verse number=\"23\" style=\"v\" />No one who denies the Son has the Father. Whoever acknowledges the Son also has the Father.\n"}, {"format": "usx", "id": "02-24", "img": "", "lastvs": "26", "text": "  <verse number=\"24\" style=\"v\" />As for you, let what you have heard from the beginning remain in you. If what you heard from the beginning remains in you, you will also remain in the Son and in the Father.\n\n  <verse number=\"25\" style=\"v\" />And this is the promise he gave to us: eternal life.\n\n  <verse number=\"26\" style=\"v\" />I have written these things to you about those who would lead you astray.\n"}, {"format": "usx", "id": "02-27", "img": "", "lastvs": "29", "text": "  <verse number=\"27\" style=\"v\" />As for you, the anointing that you received from him remains in you, and you do not need anyone to teach you. But as his anointing teaches you everything and is true and is not a lie, and just as it has taught you, remain in him.</para>\n\n<para style=\"p\">\n\n  <verse number=\"28\" style=\"v\" />And now, dear children, remain in him, so that when he appears, we will have boldness and not be ashamed before him at his coming.\n\n  <verse number=\"29\" style=\"v\" />If you know that he is righteous, you know that everyone who does what is right has been born from him.</para>\n"}], "number": "02", "ref": "", "title": ""}, {"frames": [{"format": "usx", "id": "03-01", "img": "", "lastvs": "3", "text": "<para style=\"p\">\n\n  <verse number=\"1\" style=\"v\" />See what kind of love the Father has given to us, that we should be called children of God, and this is what we are. For this reason, the world does not know us, because it did not know him.\n\n<note caller=\"+\" style=\"f\">\n\n  <char style=\"ft\">Some older versions leave out, </char>\n\n  <char style=\"fqa\">and this is what we are. </char>\n\n  <char style=\"fqb\"></char>\n\n</note>\n\n  <verse number=\"2\" style=\"v\" />Beloved, we are now children of God, and it has not yet been revealed what we will be. We know that when Christ appears, we will be like him, for we will see him just as he is.\n\n  <verse number=\"3\" style=\"v\" />Everyone who has this confidence about the future fixed on him purifies himself just as he is pure.\n"}, {"format": "usx", "id": "03-04", "img": "", "lastvs": "6", "text": "  <verse number=\"4\" style=\"v\" />Everyone who keeps sinning is doing what is lawless, for sin is lawlessness.\n\n  <verse number=\"5\" style=\"v\" />You know that Christ was revealed in order to take away sins. And in him there is no sin.\n\n  <verse number=\"6\" style=\"v\" />No one who remains in him keeps on sinning. No one who continues to sin has seen him or known him. \n"}, {"format": "usx", "id": "03-07", "img": "", "lastvs": "8", "text": "  <verse number=\"7\" style=\"v\" />Dear children, do not let anyone lead you astray. The one who does righteousness is righteous, just as Christ is righteous.\n\n  <verse number=\"8\" style=\"v\" />The one who commits sin is from the devil, for the devil has sinned from the beginning. For this reason the Son of God was revealed, so that he would destroy the devil's works.\n"}, {"format": "usx", "id": "03-09", "img": "", "lastvs": "10", "text": "  <verse number=\"9\" style=\"v\" />Whoever has been born from God does not sin because God's seed remains in him. He cannot continue to sin because he has been born from God.\n\n  <verse number=\"10\" style=\"v\" />In this the children of God and children of the devil are revealed. Whoever does not do what is righteous is not from God; neither is the one who does not love his brother.\n"}, {"format": "usx", "id": "03-11", "img": "", "lastvs": "12", "text": "  <verse number=\"11\" style=\"v\" />For this is the message that you have heard from the beginning: that we should love one another,\n\n  <verse number=\"12\" style=\"v\" />not like Cain, who was from the evil one and murdered his brother. And why did he kill him? Because his works were evil, and his brother's righteous.</para>\n"}, {"format": "usx", "id": "03-13", "img": "", "lastvs": "15", "text": "<para style=\"p\">\n\n  <verse number=\"13\" style=\"v\" />Do not be amazed, my brothers, if the world hates you.\n\n  <verse number=\"14\" style=\"v\" />We know that we have passed out of death into life, because we love the brothers. Anyone who does not love remains in death.\n\n  <verse number=\"15\" style=\"v\" />Anyone who hates his brother is a murderer. And you know that eternal life does not remain in a murderer.\n"}, {"format": "usx", "id": "03-16", "img": "", "lastvs": "18", "text": "  <verse number=\"16\" style=\"v\" />By this we know love, because Christ laid down his life for us. We also ought to lay down our lives for the brothers.\n\n  <verse number=\"17\" style=\"v\" />But whoever has the world's goods, sees his brother in need, and shuts up his heart of compassion from him, how does the love of God remain in him?\n\n  <verse number=\"18\" style=\"v\" />My dear children, let us not love in word nor in tongue, but in actions and truth.\n"}, {"format": "usx", "id": "03-19", "img": "", "lastvs": "22", "text": "  <verse number=\"19\" style=\"v\" />It is by this we know that we are from the truth, and we assure our hearts before him.\n\n  <verse number=\"20\" style=\"v\" />For if our hearts condemn us, God is greater than our hearts, and he knows all things.\n\n  <verse number=\"21\" style=\"v\" />Beloved, if our hearts do not condemn us, we have confidence toward God.\n\n  <verse number=\"22\" style=\"v\" />Whatever we ask we will receive from him, because we keep his commandments and do the things that are pleasing before him.\n"}, {"format": "usx", "id": "03-23", "img": "", "lastvs": "24", "text": "  <verse number=\"23\" style=\"v\" />This is his commandment: that we should believe in the name of his Son Jesus Christ and love one another, just as he gave us this commandment.\n\n  <verse number=\"24\" style=\"v\" />The one who keeps God's commandments remains in him, and God remains in him. By this we know that he remains in us, by the Spirit whom he gave to us.</para>\n"}], "number": "03", "ref": "", "title": ""}, {"frames": [{"format": "usx", "id": "04-01", "img": "", "lastvs": "3", "text": "<para style=\"p\">\n\n  <verse number=\"1\" style=\"v\" />Beloved, do not believe every spirit. Instead, test the spirits to see whether they are from God, because many false prophets have gone out into the world.\n\n  <verse number=\"2\" style=\"v\" />By this you will know the Spirit of God\u2014every spirit that acknowledges that Jesus Christ has come in the flesh is from God,\n\n  <verse number=\"3\" style=\"v\" />and every spirit that does not acknowledge Jesus is not from God. This is the spirit of the antichrist, which you have heard is coming, and now is already in the world.\n\n<note caller=\"+\" style=\"f\">\n\n  <char style=\"ft\">Some older versions read, </char>\n\n  <char style=\"fqa\">and every spirit that does not acknowledge that Jesus has come in the flesh is not from God. This is the spirit of the antichrist, which you have heard is coming, and now is already in the world. </char>\n\n  <char style=\"fqa\"></char>\n\n</note>\n"}, {"format": "usx", "id": "04-04", "img": "", "lastvs": "6", "text": "  <verse number=\"4\" style=\"v\" />You are from God, dear children, and have overcome them because the one who is in you is greater than the one who is in the world.\n\n  <verse number=\"5\" style=\"v\" />They are from the world; therefore what they say is from the world, and the world listens to them.\n\n  <verse number=\"6\" style=\"v\" />We are from God. Anyone who knows God listens to us. He who is not from God does not listen to us. By this we know the spirit of truth and the spirit of error.</para>\n"}, {"format": "usx", "id": "04-07", "img": "", "lastvs": "8", "text": "<para style=\"p\">\n\n  <verse number=\"7\" style=\"v\" />Beloved, let us love one another, for love is from God, and everyone who loves is born from God and knows God.\n\n  <verse number=\"8\" style=\"v\" />The person who does not love does not know God, for God is love.\n"}, {"format": "usx", "id": "04-09", "img": "", "lastvs": "10", "text": "  <verse number=\"9\" style=\"v\" />Because of this the love of God was revealed among us, that God has sent his only Son into the world so that we would live because of him.\n\n  <verse number=\"10\" style=\"v\" />In this is love, not that we loved God, but that he loved us, and that he sent his Son to be the propitiation for our sins.\n"}, {"format": "usx", "id": "04-11", "img": "", "lastvs": "14", "text": "  <verse number=\"11\" style=\"v\" />Beloved, if God so loved us, we also should love one another.\n\n  <verse number=\"12\" style=\"v\" />No one has ever seen God. If we love one another, God remains in us, and his love is perfected in us.\n\n  <verse number=\"13\" style=\"v\" />By this we know that we remain in him and he in us, because he has given us some of his Spirit.\n\n  <verse number=\"14\" style=\"v\" />Also, we have seen and have borne witness that the Father has sent the Son to be the Savior of the world.\n"}, {"format": "usx", "id": "04-15", "img": "", "lastvs": "16", "text": "  <verse number=\"15\" style=\"v\" />Whoever acknowledges that Jesus is the Son of God, God remains in him and he in God.\n\n  <verse number=\"16\" style=\"v\" />Also, we have known and believed the love that God has for us. God is love, and the one who remains in this love remains in God, and God remains in him.\n"}, {"format": "usx", "id": "04-17", "img": "", "lastvs": "18", "text": "  <verse number=\"17\" style=\"v\" />Because of this, this love has been made perfect among us, so that we will have confidence on the day of judgment, because as he is, just so are we in this world.\n\n  <verse number=\"18\" style=\"v\" />There is no fear in love. Instead, perfect love throws fear out, because fear has to do with punishment. But the one who fears has not been made perfect in love.\n"}, {"format": "usx", "id": "04-19", "img": "", "lastvs": "21", "text": "  <verse number=\"19\" style=\"v\" />We love because God first loved us.\n\n  <verse number=\"20\" style=\"v\" />If anyone says, \"I love God\" but hates his brother, he is a liar. For the one who does not love his brother, whom he has seen, cannot love God, whom he has not seen.\n\n  <verse number=\"21\" style=\"v\" />Also, this is the commandment we have from him: Whoever loves God must also love his own brother.</para>\n"}], "number": "04", "ref": "", "title": ""}, {"frames": [{"format": "usx", "id": "05-01", "img": "", "lastvs": "3", "text": "<para style=\"p\">\n\n  <verse number=\"1\" style=\"v\" />Whoever believes that Jesus is the Christ is born from God. And whoever loves a father also loves the child born from him.\n\n  <verse number=\"2\" style=\"v\" />Because of this we know that we love God's children: when we love God and do his commandments.\n\n  <verse number=\"3\" style=\"v\" />For this is love for God: that we keep his commandments. And his commandments are not burdensome.\n"}, {"format": "usx", "id": "05-04", "img": "", "lastvs": "5", "text": "  <verse number=\"4\" style=\"v\" />For everyone who is born from God overcomes the world. And this is the victory that has overcome the world: our faith.\n\n  <verse number=\"5\" style=\"v\" />Who is the one who overcomes the world? The one who believes that Jesus is the Son of God.\n"}, {"format": "usx", "id": "05-06", "img": "", "lastvs": "8", "text": "  <verse number=\"6\" style=\"v\" />This is the one who came by water and blood: Jesus Christ. He came not only by water, but by water and blood.\n\n  <verse number=\"7\" style=\"v\" />For there are three who bear witness:\n\n  <verse number=\"8\" style=\"v\" />the Spirit, the water, and the blood. These three are in agreement.\n\n<note caller=\"+\" style=\"f\">\n\n  <char style=\"ft\">Some older versions read, </char>\n\n  <char style=\"fqa\">For there are three that bear witness in heaven: the Father, the Word, and the Holy Spirit; and these three are one. And there are three that bear witness on earth: the Spirit, the water, and the blood; and these three are as one. </char>\n\n  <char style=\"fqb\">However, the best copies do not have this reading. </char>\n\n</note>\n"}, {"format": "usx", "id": "05-09", "img": "", "lastvs": "10", "text": "  <verse number=\"9\" style=\"v\" />If we receive the witness of men, the witness of God is greater. For the testimony of God is this, that he has borne witness concerning his Son.\n\n  <verse number=\"10\" style=\"v\" />Anyone who believes in the Son of God has the testimony in himself. Anyone who does not believe God has made him out to be a liar, because he has not believed the witness that God has given concerning his Son.\n"}, {"format": "usx", "id": "05-11", "img": "", "lastvs": "12", "text": "  <verse number=\"11\" style=\"v\" />And the witness is this: God gave us eternal life, and this life is in his Son.\n\n  <verse number=\"12\" style=\"v\" />The one who has the Son has life. The one who does not have the Son of God does not have life.</para>\n\n<para style=\"b\" />\n"}, {"format": "usx", "id": "05-13", "img": "", "lastvs": "15", "text": "<para style=\"p\">\n\n  <verse number=\"13\" style=\"v\" />I have written to you these things so that you will know that you have eternal life\u2014to you who believe in the name of the Son of God.\n\n  <verse number=\"14\" style=\"v\" />Also, this is the confidence we have before him, that if we ask anything according to his will, he hears us.\n\n  <verse number=\"15\" style=\"v\" />Also, if we know that he hears us\u2014whatever we ask of him\u2014we know that we have whatever we have asked of him.\n"}, {"format": "usx", "id": "05-16", "img": "", "lastvs": "17", "text": "  <verse number=\"16\" style=\"v\" />If anyone sees his brother commit a sin that does not result in death, he must pray, and God will give him life. I refer to those whose sin does not result in death. There is a sin that results in death; I am not saying that he should pray about that.\n\n  <verse number=\"17\" style=\"v\" />All unrighteousness is sin, but there is sin that does not result in death. </para>\n"}, {"format": "usx", "id": "05-18", "img": "", "lastvs": "19", "text": "<para style=\"p\">\n\n  <verse number=\"18\" style=\"v\" />We know that whoever is born from God does not sin. But the one who was born from God keeps him safe, and the evil one cannot harm him.\n\n  <verse number=\"19\" style=\"v\" />We know that we are from God, and we know that the whole world lies in the evil one.\n"}, {"format": "usx", "id": "05-00", "img": "", "lastvs": "21", "text": "  <verse number=\"20\" style=\"v\" />But we know that the Son of God has come and has given us understanding so that we know the one who is true. Also, we are in the one who is true, in his Son Jesus Christ. He is the true God and eternal life.\n\n  <verse number=\"21\" style=\"v\" />Children, keep yourselves from idols.</para>"}], "number": "05", "ref": "", "title": ""}], "date_modified": "20160830"});
        let props = {
            language: {
                slug: 'en',
                name: 'English'
            },
            project: {
                slug: '1jn',
                name: '1 John'
            },
            resource: {
                slug: 'ulb',
                name: 'Unlocked Literal Bible',
                type: 'book',
                modified_at: 0,
                status: {
                    license: 'some license'
                }
            }
        };

        return rc.tools.convertResource(data, 'dest/dir', props)
            .then(function(container) {
                // ensure no chunk 00 bug
                expect(fs.statSync('dest/dir/content/05/00.usfm').isFile()).toEqual(false);
                expect(fs.statSync('dest/dir/content/05/20.usfm').isFile()).toEqual(true);
            });
    });
});